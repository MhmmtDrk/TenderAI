@model TenderAI.Domain.Entities.Tender
@{
    ViewData["Title"] = "ƒ∞hale Detayƒ±";
}

<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index">Ana Sayfa</a></li>
            <li class="breadcrumb-item"><a asp-controller="Tender" asp-action="Index">ƒ∞haleler</a></li>
            <li class="breadcrumb-item active" aria-current="page">Detay</li>
        </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1 class="h3 mb-2">@Model.Title</h1>
            <p class="text-muted mb-0">
                <i class="bi bi-building"></i> @Model.AuthorityName
            </p>
        </div>
        <div>
            <a asp-action="AnalysisWizard" asp-route-id="@Model.Id" class="btn btn-success me-2">
                <i class="bi bi-magic"></i> Toplu Analiz
            </a>
            <span class="badge bg-primary fs-6">@Model.Status</span>
        </div>
    </div>
</div>

<!-- √ñzet Kartlar -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="text-muted small mb-1">ƒ∞KN Numarasƒ±</div>
                <div class="fw-bold">@Model.IKN</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="text-muted small mb-1">ƒ∞hale T√ºr√º</div>
                <div class="fw-bold">@Model.TenderType</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="text-muted small mb-1">Yakla≈üƒ±k Maliyet</div>
                <div class="fw-bold text-success">‚Ç∫@Model.EstimatedCost.ToString("N0")</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="text-muted small mb-1">Son Teklif Tarihi</div>
                @{
                    var daysLeft = (Model.BidDeadline - DateTime.Now).Days;
                    var dateClass = daysLeft <= 3 ? "text-danger" : daysLeft <= 7 ? "text-warning" : "text-primary";
                }
                <div class="fw-bold @dateClass">
                    @Model.BidDeadline.ToString("dd.MM.yyyy HH:mm")
                    <br />
                    <small>(@daysLeft g√ºn kaldƒ±)</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ana Bilgiler -->
<div class="row g-4">
    <div class="col-lg-8">
        <!-- ƒ∞hale Bilgileri -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üìã ƒ∞hale Bilgileri</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <td class="text-muted" style="width: 200px;">ƒ∞hale Kodu (ƒ∞KN)</td>
                            <td><code>@Model.IKN</code></td>
                        </tr>
                        <tr>
                            <td class="text-muted">ƒ∞hale Adƒ±</td>
                            <td><strong>@Model.Title</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted">ƒ∞hale T√ºr√º</td>
                            <td>@Model.TenderType</td>
                        </tr>
                        <tr>
                            <td class="text-muted">ƒ∞hale Usul√º</td>
                            <td>@Model.ProcurementMethod</td>
                        </tr>
                        <tr>
                            <td class="text-muted">ƒ∞haleyi Yapan ƒ∞dare</td>
                            <td>@Model.AuthorityName</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Yakla≈üƒ±k Maliyet</td>
                            <td class="text-success fw-bold">‚Ç∫@Model.EstimatedCost.ToString("N2")</td>
                        </tr>
                        <tr>
                            <td class="text-muted">ƒ∞l / ƒ∞l√ße</td>
                            <td>@Model.Province / @Model.District</td>
                        </tr>
                        @if (!string.IsNullOrEmpty(Model.OkasCode))
                        {
                            <tr>
                                <td class="text-muted">OKAS Kodu</td>
                                <td>@Model.OkasCode</td>
                            </tr>
                        }
                        <tr>
                            <td class="text-muted">E-ƒ∞hale Mi?</td>
                            <td>
                                @if (Model.IsElectronic)
                                {
                                    <span class="badge bg-success">‚úì Evet</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">‚úó Hayƒ±r</span>
                                }
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tarihler -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üìÖ √ñnemli Tarihler</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        @if (Model.OpeningDate.HasValue)
                        {
                            <tr>
                                <td class="text-muted" style="width: 200px;">ƒ∞hale A√ßƒ±lƒ±≈ü Tarihi</td>
                                <td>@Model.OpeningDate.Value.ToString("dd.MM.yyyy HH:mm")</td>
                            </tr>
                        }
                        <tr>
                            <td class="text-muted">Son Teklif Tarihi</td>
                            <td>
                                <strong class="@dateClass">
                                    @Model.BidDeadline.ToString("dd.MM.yyyy HH:mm")
                                </strong>
                                <span class="badge bg-info ms-2">@daysLeft g√ºn kaldƒ±</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Sisteme Eklenme</td>
                            <td>@Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Son G√ºncelleme</td>
                            <td>@Model.UpdatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dok√ºmanlar -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìÑ ƒ∞hale Dok√ºmanlarƒ±</h5>
            </div>
            <div class="card-body">
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-circle"></i> @TempData["ErrorMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                @if (Model.EkapId != null)
                {
                    var docTypes = new[] {
                        new { Id = "1", Name = "ƒ∞hale ƒ∞lanƒ±", Icon = "file-earmark-text" },
                        new { Id = "2", Name = "Teknik ≈ûartname", Icon = "gear" },
                        new { Id = "3", Name = "ƒ∞dari ≈ûartname", Icon = "file-earmark-ruled" },
                        new { Id = "4", Name = "S√∂zle≈üme Tasarƒ±sƒ±", Icon = "file-earmark-check" },
                        new { Id = "5", Name = "BFTC", Icon = "file-earmark-spreadsheet" }
                    };

                    var documents = ViewBag.Documents as List<TenderAI.Domain.Entities.TenderDocument> ?? new List<TenderAI.Domain.Entities.TenderDocument>();
                    var analyses = ViewBag.Analyses as Dictionary<Guid, TenderAI.Domain.Entities.DocumentAnalysis> ?? new Dictionary<Guid, TenderAI.Domain.Entities.DocumentAnalysis>();

                    <div class="list-group">
                        @foreach (var doc in docTypes)
                        {
                            var uploadedDoc = documents.FirstOrDefault(d => d.DocumentType == doc.Id && d.DownloadedAt != null);
                            var analysis = uploadedDoc != null && analyses.ContainsKey(uploadedDoc.Id) ? analyses[uploadedDoc.Id] : null;

                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <i class="bi bi-@doc.Icon text-danger me-2"></i>
                                        <strong>@doc.Name</strong>
                                        @if (uploadedDoc != null)
                                        {
                                            <span class="badge bg-success ms-2"><i class="bi bi-check-circle"></i> Y√ºklendi</span>
                                        }
                                        @if (analysis != null)
                                        {
                                            var riskBadge = analysis.RiskLevel switch { "D√º≈ü√ºk" => "bg-success", "Orta" => "bg-warning text-dark", "Y√ºksek" => "bg-danger", "√áok Y√ºksek" => "bg-danger", _ => "bg-secondary" };
                                            <span class="badge @riskBadge ms-2"><i class="bi bi-robot"></i> Risk: @analysis.RiskScore</span>
                                        }
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="@Url.Action("DownloadDocument", "Tender", new { ikn = Model.IKN, islemId = doc.Id })" class="btn btn-outline-primary" title="Otomatik ƒ∞ndir (EKAP API)">
                                            <i class="bi bi-download"></i> Otomatik ƒ∞ndir
                                        </a>
                                        <button type="button" class="btn btn-outline-success" onclick="showUploadModal('@doc.Id', '@doc.Name')" title="Manuel Y√ºkle">
                                            <i class="bi bi-upload"></i> Manuel Y√ºkle
                                        </button>
                                        @if (uploadedDoc != null)
                                        {
                                            if (analysis == null)
                                            {
                                                <button type="button" class="btn btn-outline-info" onclick="analyzeDocument('@uploadedDoc.Id', '@doc.Name')" id="analyzeBtn_@uploadedDoc.Id" title="AI ile Analiz Et">
                                                    <i class="bi bi-robot"></i> Analiz Et
                                                </button>
                                            }
                                            else
                                            {
                                                <a href="@Url.Action("AnalysisResult", "Tender", new { documentId = uploadedDoc.Id })" class="btn btn-outline-info" title="Analiz Sonucunu G√∂r">
                                                    <i class="bi bi-eye"></i> Sonu√ß
                                                </a>
                                                <button type="button" class="btn btn-outline-warning" onclick="reAnalyzeDocument('@uploadedDoc.Id', '@doc.Name')" id="reAnalyzeBtn_@uploadedDoc.Id" title="Yeniden Analiz Et">
                                                    <i class="bi bi-arrow-repeat"></i> Yeniden Analiz
                                                </button>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle"></i> <strong>Nasƒ±l √ßalƒ±≈üƒ±r?</strong>
                        <ul class="mb-0 mt-2">
                            <li><strong>EKAP:</strong> EKAP sitesinde dok√ºmanƒ± indirin (captcha √ß√∂zmeniz gerekebilir)</li>
                            <li><strong>Y√ºkle:</strong> ƒ∞ndirdiƒüiniz PDF/ZIP dosyasƒ±nƒ± sisteme y√ºkleyin</li>
                            <li>Y√ºklenen dok√ºmanlar AI analizi i√ßin kullanƒ±lacaktƒ±r</li>
                        </ul>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i> Bu ihale i√ßin EKAP ID bilgisi bulunamadƒ±. D√∂k√ºmanlar g√∂sterilemiyor.
                    </div>
                }
            </div>
        </div>

        <!-- Manuel Y√ºkleme Modal -->
        <div class="modal fade" id="uploadModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="uploadForm" asp-controller="Tender" asp-action="UploadDocument" method="post" enctype="multipart/form-data">
                        <div class="modal-header">
                            <h5 class="modal-title">Dok√ºman Y√ºkle: <span id="modalDocName"></span></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="ikn" value="@Model.IKN" />
                            <input type="hidden" name="documentType" id="modalDocType" />
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Dosya Se√ßin (PDF, DOC, DOCX veya ZIP)</label>
                                <input type="file" class="form-control" name="file" id="fileInput" accept=".pdf,.doc,.docx,.zip" required />
                                <div class="form-text">Maksimum dosya boyutu: 50MB</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-upload"></i> Y√ºkle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Hƒ±zlƒ± ƒ∞≈ülemler -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">‚ö° Hƒ±zlƒ± ƒ∞≈ülemler</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    @if (Model.RiskAnalysis == null)
                    {
                        <form asp-controller="Tender" asp-action="StartAnalysis" method="post">
                            <input type="hidden" name="tenderId" value="@Model.Id" />
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-robot"></i> AI ile Analiz Et
                            </button>
                        </form>
                    }
                    else
                    {
                        <a asp-controller="Tender" asp-action="AnalysisWizard" asp-route-id="@Model.Id" class="btn btn-info">
                            <i class="bi bi-graph-up"></i> Analiz Sonu√ßlarƒ±nƒ± G√∂r
                        </a>
                    }
                    <a href="https://ekap.kik.gov.tr/EKAP/Ortak/IhaleArama/index.html?IKN=@Model.IKN"
                       target="_blank" class="btn btn-outline-primary">
                        <i class="bi bi-box-arrow-up-right"></i> EKAP'ta G√∂r√ºnt√ºle
                    </a>
                    <a asp-controller="Tender" asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Listeye D√∂n
                    </a>
                </div>
            </div>
        </div>

        <!-- Risk Analizi -->
        @if (Model.RiskAnalysis != null)
        {
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚ö†Ô∏è Risk Analizi</h5>
                </div>
                <div class="card-body">
                    @{
                        var riskBadgeClass = Model.RiskAnalysis.RiskLevel switch
                        {
                            "D√º≈ü√ºk" => "bg-success",
                            "Orta" => "bg-warning text-dark",
                            "Y√ºksek" => "bg-danger",
                            "√áok Y√ºksek" => "bg-danger",
                            _ => "bg-secondary"
                        };
                    }
                    <div class="text-center mb-3">
                        <div class="display-4 fw-bold mb-2">@Model.RiskAnalysis.TotalRiskScore.ToString("F0")</div>
                        <span class="badge @riskBadgeClass fs-6">@Model.RiskAnalysis.RiskLevel Risk</span>
                    </div>
                    <div class="alert alert-light mb-0">
                        <strong>Risk Fakt√∂rleri:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Finansal Risk: @Model.RiskAnalysis.FinancialRiskScore.ToString("F0")</li>
                            <li>Operasyonel Risk: @Model.RiskAnalysis.OperationalRiskScore.ToString("F0")</li>
                            <li>Hukuki Risk: @Model.RiskAnalysis.LegalRiskScore.ToString("F0")</li>
                        </ul>
                    </div>
                    <a asp-controller="Tender" asp-action="AnalysisWizard" asp-route-id="@Model.Id"
                       class="btn btn-info w-100 mt-3">
                        Detaylƒ± Analizi G√∂r
                    </a>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Detay sayfasƒ± interaktivitesi
        console.log('ƒ∞hale Detay Sayfasƒ± Y√ºklendi:', '@Model.IKN');

        // Modal a√ßma fonksiyonu
        function showUploadModal(docType, docName) {
            document.getElementById('modalDocType').value = docType;
            document.getElementById('modalDocName').textContent = docName;
            document.getElementById('fileInput').value = '';
            var modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            modal.show();
        }

        // Dok√ºman analizi fonksiyonu
        function analyzeDocument(documentId, docName) {
            const btn = document.getElementById('analyzeBtn_' + documentId);
            if (!btn) return;

            if (!confirm('Bu dok√ºmanƒ± Gemini AI ile analiz etmek istediƒüinize emin misiniz?\n\nDok√ºman: ' + docName)) {
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Analiz ediliyor...';

            fetch('@Url.Action("AnalyzeDocument", "Tender")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ documentId: documentId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Analiz tamamlandƒ±!\n\n' +
                          'Risk Skoru: ' + data.analysis.riskScore + '\n' +
                          'Risk Seviyesi: ' + data.analysis.riskLevel + '\n' +
                          'S√ºre: ' + data.analysis.duration.toFixed(2) + ' saniye\n\n' +
                          'Sayfa yenileniyor...');
                    location.reload();
                } else {
                    alert('‚ùå Hata: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-robot"></i> Analiz Et';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Analiz sƒ±rasƒ±nda bir hata olu≈ütu: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-robot"></i> Analiz Et';
            });
        }

        // Dok√ºmanƒ± yeniden analiz et (eski analizi sil ve yeniden yap)
        function reAnalyzeDocument(documentId, docName) {
            const btn = document.getElementById('reAnalyzeBtn_' + documentId);
            if (!btn) return;

            if (!confirm('Bu dok√ºmanƒ± yeniden analiz etmek istediƒüinize emin misiniz?\n\nEski analiz silinecek ve yeni bir analiz yapƒ±lacak.\n\nDok√ºman: ' + docName)) {
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Yeniden analiz ediliyor...';

            fetch('@Url.Action("ReAnalyzeDocument", "Tender")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ documentId: documentId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = '‚úÖ Yeniden analiz tamamlandƒ±!\n\n' +
                          'Risk Skoru: ' + data.analysis.riskScore + '\n' +
                          'Risk Seviyesi: ' + data.analysis.riskLevel + '\n' +
                          'S√ºre: ' + data.analysis.duration.toFixed(2) + ' saniye';

                    if (data.analysis.hasBftcData) {
                        message += '\n\nüéØ BFTC tablo verisi extract edildi!';
                    }

                    message += '\n\nSayfa yenileniyor...';
                    alert(message);
                    location.reload();
                } else {
                    alert('‚ùå Hata: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Yeniden Analiz';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Yeniden analiz sƒ±rasƒ±nda bir hata olu≈ütu: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Yeniden Analiz';
            });
        }
    </script>
}
